# nginx conf
load_module modules/ngx_mail_module.so;

daemon off;
pid /nginx.pid;
# 'notice' adds boring stuff about nginx start/stop
error_log /data/logs/error.log warn;

worker_processes auto;
events { worker_connections 1024; }

http {
	include /etc/nginx/mime.types;
	access_log /data/logs/http.access.log.gz combined gzip;
	# 'info' logs noise about closed keepalive connections
	error_log /data/logs/http.log notice;
	log_not_found off;

	ssl_certificate     /data/cert/fullchain.pem;
	ssl_certificate_key /data/cert/privkey.pem;
	ssl_session_cache   shared:SSL:10m;
	# see https://wiki.mozilla.org/Security/Server_Side_TLS
	# and https://ssl-config.mozilla.org/
	ssl_protocols       TLSv1.2 TLSv1.3;
	ssl_ciphers         ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305;


	include servers[.]conf;

	server {
		listen              443 ssl http2;
		listen              [::]:443 ssl http2;
		server_name         squirrelmail.shpakovsky.ru;
		access_log          /data/logs/squirrelmail.log.gz combined gzip;
		auth_basic          "huh?";
		auth_basic_user_file /data/conf/passwd.txt;
		location /         { proxy_pass http://127.0.0.1:8001; }
	}

	server {
		listen              443 ssl http2;
		listen              [::]:443 ssl http2;
		server_name         baikal.shpakovsky.ru;
		access_log          /data/logs/baikal.log.gz combined gzip;
		location /admin/   { return 403; }
		location /carddav  { return 301 /infcloud; }
		location /infcloud/ { root /data/secure/baikal.shpakovsky.ru; }
		location /.well-known/carddav { return 301 /dav.php; }
		location /.well-known/caldav  { return 301 /dav.php; }
		location /          {
			proxy_pass http://127.0.0.1:8002;
			proxy_set_header Host       $host;
			proxy_set_header X-Forwarded-Proto $scheme;
			}
	}

	server {
		listen              443 ssl http2;
		listen              [::]:443 ssl http2;
		server_name         mta-sts.shpakovsky.ru;
		access_log          /data/logs/mta-sts.log.gz combined gzip;
		location /.well-known/mta-sts.txt {
			return 200 "version: STSv1\nmode: testing\nmx: shpakovsky.ru\nmax_age: 86401";
			access_log off;
		}
	}

	server {
		listen              80 default_server;
		listen              [::]:80 default_server;
		listen              443 default_server ssl http2;
		listen              [::]:443 default_server ssl http2;
		# there's only noise there
		access_log          off;
		error_log           /dev/null emerg;
		location /robots.txt { return 200 "User-agent: *\nDisallow: /"; }
		location /         { return 404; }
	}

	# map $http_auth_method $auth_loggable {
	# 	"none"  0;
	# 	default 1;
	# }
	log_format auth "$time_local $http_auth_protocol auth $http_auth_method [$http_auth_user] [$http_auth_pass] from $http_client_ip";
        server {
		listen 127.0.0.1:2580;
		# NOTE: it's best to avoid having 'if' under 'location'
		# ref https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/
		# fail all login attempts
		if ($http_auth_method != "none")   { rewrite /auth /fail break; }
		# fail pop3 and imap logins
		if ($http_auth_protocol != "smtp") { rewrite /auth /fail break; }
		location = /auth {
			add_header Auth-Status OK;
			add_header Auth-Server 127.0.0.1;  # backend ip
			add_header Auth-Port   2525;       # backend port
			# access_log /data/logs/auth.log.gz auth gzip if=$auth_loggable;
			access_log off;
			return 200;
		}
		location = /fail {
			add_header Auth-Status "try again with a different username and password";
			add_header Auth-Wait 3;
			access_log /data/logs/auth.log.gz auth gzip flush=5m;
			return 200;
		}
	}
}

mail {
	server_name shpakovsky.ru;
	auth_http 127.0.0.1:2580/auth;
	smtp_auth none;
	smtp_capabilities "PIPELINING" "SIZE 10240000" "VRFY" "ETRN" "ENHANCEDSTATUSCODES" "8BITMIME" "DSN" "CHUNKING";
	proxy_pass_error_message on;

	# 'info' adds lots of stuff about failed login attempts
	error_log /data/logs/mail.log notice;

	starttls on;
	ssl_certificate     /data/cert/fullchain.pem;
	ssl_certificate_key /data/cert/privkey.pem;

	server {
		listen     25;
		listen     587;
		listen     465 ssl;
		listen     [::]:25;
		listen     [::]:587;
		listen     [::]:465 ssl;
		protocol   smtp;
		proxy      on;
	}

	server {
		listen     110;
		listen     995 ssl;
		listen     [::]:110;
		listen     [::]:995 ssl;
		protocol   pop3;
	}

	server {
		listen     143;
		listen     993 ssl;
		listen     [::]:143;
		listen     [::]:993 ssl;
		protocol   imap;
	}
}
